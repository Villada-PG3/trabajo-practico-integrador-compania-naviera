{% extends "base.html" %}
{% block content %}
<style>
  /* Ajustes locales para el bloque de acciones de pasajeros */
  .passenger-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    align-items: center;
    padding: 0.85rem;
    border-radius: 1.4rem;
    border: 1.5px solid rgba(122, 62, 242, 0.28);
    background: linear-gradient(145deg, rgba(255, 255, 255, 0.96), rgba(245, 240, 255, 0.85));
    box-shadow: 0 10px 24px rgba(15, 30, 99, 0.08);
  }
  .action-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.45rem;
    border-radius: 0.95rem;
    padding: 0.85rem 1.15rem;
    font-weight: 700;
    font-size: 1rem;
    border: 1px solid transparent;
    transition: transform 120ms ease, box-shadow 160ms ease, background 160ms ease, border-color 160ms ease;
    min-height: 3rem;
  }
  .action-btn--primary {
    background: linear-gradient(135deg, rgba(122, 62, 242, 0.92), rgba(31, 58, 147, 0.9));
    color: #FFFFFF;
    border-color: rgba(122, 62, 242, 0.55);
    box-shadow: 0 12px 22px rgba(122, 62, 242, 0.25);
  }
  .action-btn--primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 16px 26px rgba(122, 62, 242, 0.28);
  }
  .action-btn--primary:disabled {
    background: #EAE2FF;
    color: #4B1BB2;
    border-color: rgba(122, 62, 242, 0.28);
    box-shadow: none;
    opacity: 1;
  }
  .action-btn--secondary {
    background: #FFFFFF;
    color: var(--primary-dark);
    border-color: rgba(31, 58, 147, 0.2);
    box-shadow: 0 8px 18px rgba(15, 30, 99, 0.08);
  }
  .action-btn--secondary:hover {
    background: rgba(31, 58, 147, 0.05);
    border-color: rgba(31, 58, 147, 0.3);
    transform: translateY(-1px);
  }
</style>
<div class="relative max-w-6xl mx-auto p-6 md:p-8">
  <div class="absolute inset-0 -z-10 rounded-3xl bg-gradient-to-br from-white/85 via-white/70 to-primary/8 shadow-[0_18px_48px_rgba(15,30,99,0.12)]"></div>
  <div class="absolute -left-10 -top-10 h-48 w-48 rounded-full bg-secondary/12 blur-3xl"></div>
  <div class="absolute -right-12 bottom-6 h-52 w-52 rounded-full bg-primary/14 blur-3xl"></div>

  <div class="relative grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- LEFT: formulario -->
    <div class="lg:col-span-2 space-y-5">
      <div class="flex items-start justify-between gap-3">
        <div>
          <p class="uppercase tracking-[0.18em] text-xs font-semibold text-secondary">Paso 2 · Pasajeros</p>
          <h1 class="text-3xl md:text-4xl font-extrabold text-primary-dark leading-tight">Tutor y Pasajeros</h1>
          <p class="text-base text-text/70">Revisá el tutor (tu perfil) y agregá pasajeros. Podés autocompletar el primer pasajero con tus datos.</p>
        </div>
        <div class="hidden md:flex items-center gap-2 px-4 py-3 rounded-full bg-white shadow-[0_10px_26px_rgba(15,30,99,0.12)] border border-primary/12 text-primary-dark font-semibold text-sm">
          <i class="fa-solid fa-user-group text-secondary"></i>
          Capacidad: {{ carrito.capacidad_max|default:"-" }}
        </div>
      </div>

      <form method="post" id="form-tutor-pasajeros" class="space-y-5">
        {% csrf_token %}

        <!-- Tutor (mostrar, no pedir de nuevo) -->
        <div class="p-5 rounded-2xl border border-primary/15 bg-white shadow-[0_18px_36px_rgba(15,30,99,0.1)]">
          <div class="flex items-center gap-2 text-primary-dark font-semibold">
            <span class="inline-flex h-9 w-9 items-center justify-center rounded-xl bg-primary/12 text-primary"><i class="fa-solid fa-id-card"></i></span>
            <h3 class="text-lg font-semibold">Tutor (responsable)</h3>
          </div>
          <p class="text-base text-text/75 mt-3 leading-relaxed">
            {{ cliente.nombre }} {{ cliente.apellido }} • DNI: {{ cliente.dni }}<br>
            {{ cliente.direccion }} • {{ cliente.nacionalidad }} • {{ cliente.fecha_nacimiento }}
          </p>
        </div>

        <!-- Controles pasajeros -->
        <div id="pasajeros-area" class="space-y-4"></div>

        <div class="mt-2 passenger-actions">
          <button type="button" id="btn-copy-tutor" class="action-btn action-btn--primary">
            <i class="fa-solid fa-copy"></i> Copiar tutor como pasajero 1
          </button>
          <button type="button" id="btn-add-passenger" class="action-btn action-btn--secondary">
            <i class="fa-solid fa-user-plus text-secondary"></i> Agregar pasajero
          </button>
          <input type="hidden" name="total_pasajeros_submitted" id="total_pasajeros_submitted" value="0">
        </div>

        <div class="flex flex-wrap items-center gap-3 pt-2">
          <a href="{% url 'reserva_step1' %}?viaje_navio_id={{ viaje_navio.id }}" class="px-4 py-2 rounded-xl btn-secondary transition font-semibold hover:scale-[1.02]">
            Volver
          </a>
          <button type="submit" class="px-5 py-2 rounded-xl btn-primary font-semibold shadow-md transition hover:scale-[1.01]">
            Siguiente (Confirmar)
          </button>
        </div>
      </form>
    </div>

    <!-- RIGHT: carrito -->
    <aside class="lg:col-span-1">
      <div class="p-6 rounded-3xl border border-primary/15 bg-white shadow-[0_20px_40px_rgba(15,30,99,0.16)] sticky top-24" style="z-index: 12000;">
        <div class="flex items-center gap-2 text-primary-dark font-semibold">
          <span class="inline-flex h-9 w-9 items-center justify-center rounded-xl bg-primary/12 text-primary"><i class="fa-solid fa-clipboard-list"></i></span>
          <h3 class="text-lg font-semibold">Resumen</h3>
        </div>
        <div class="mt-3 text-sm space-y-3 leading-relaxed">
          <p><strong>Viaje:</strong><br>{{ carrito.viaje_display }}</p>
          <p><strong>Tipo:</strong><br>{{ carrito.tipo_display }}</p>
          <p class="flex items-center gap-2"><strong>Capacidad máx:</strong> {{ carrito.capacidad_max }}</p>
          <p class="flex items-center gap-2"><strong>Precio:</strong> ${{ carrito.precio }}</p>

          <div class="pt-1">
            <strong>Pasajeros:</strong>
            <ul id="carrito-pasajeros-list" class="mt-1 pl-4 text-sm space-y-1">
              {% for p in carrito.pasajeros %}
                <li>{{ p.nombre }} {{ p.apellido }}</li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- JS: dinámico -->
<script>
  const capacidadMax = parseInt("{{ carrito.capacidad_max|default:1 }}") || 1;
  const pasajerosArea = document.getElementById('pasajeros-area');
  const totalInput = document.getElementById('total_pasajeros_submitted');
  const carritoList = document.getElementById('carrito-pasajeros-list');

  let pasajerosCount = 0;

  function renderPasajeroForm(index, data = {}) {
    const wrapper = document.createElement('div');
    wrapper.className = 'p-4 rounded-2xl border border-primary/12 bg-white shadow-[0_12px_28px_rgba(15,30,99,0.08)]';
    wrapper.dataset.isTutor = isTutorData(data) ? '1' : '';
    wrapper.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-sm">Nombre</label>
          <input name="pasajero_${index}_nombre" class="w-full border rounded p-2" value="${data.nombre || ''}" required>
        </div>
        <div>
          <label class="text-sm">Apellido</label>
          <input name="pasajero_${index}_apellido" class="w-full border rounded p-2" value="${data.apellido || ''}" required>
        </div>
        <div>
          <label class="text-sm">DNI</label>
          <input name="pasajero_${index}_dni" class="w-full border rounded p-2" value="${data.dni || ''}">
        </div>
        <div>
          <label class="text-sm">Fecha de nacimiento</label>
          <input type="date" name="pasajero_${index}_fecha_nac" class="w-full border rounded p-2" value="${data.fecha_nacimiento || ''}">
        </div>
      </div>
      <div class="mt-3 text-right">
        <button type="button" class="btn-remove text-sm text-red-500">Eliminar</button>
      </div>
    `;
    pasajerosArea.appendChild(wrapper);

    // actualizar contadores
    pasajerosCount++;
    totalInput.value = pasajerosCount;
    updateCarritoList();

    // eliminar
    wrapper.querySelector('.btn-remove').addEventListener('click', function(){
      const wasTutor = wrapper.dataset.isTutor === '1';
      wrapper.remove();
      pasajerosCount--;
      totalInput.value = pasajerosCount;
      if (wasTutor) {
        tutorAdded = false;
        copyBtn.removeAttribute('disabled');
      }
      updateCarritoList();
    });
  }

  function updateCarritoList(){
    carritoList.innerHTML = '';
    // buscamos todos los forms de pasajeros y listamos nombre/apellido
    const inputsNombre = pasajerosArea.querySelectorAll('[name^="pasajero_"][name$="_nombre"]');
    inputsNombre.forEach((input, idx) => {
      const apellido = pasajerosArea.querySelector(`[name="pasajero_${idx}_apellido"]`);
      if(input.value || (apellido && apellido.value)) {
        const li = document.createElement('li');
        li.textContent = `${input.value} ${apellido ? apellido.value : ''}`;
        carritoList.appendChild(li);
      }
    });
  }

  // agregar pasajero (hasta capacidadMax)
  document.getElementById('btn-add-passenger').addEventListener('click', function(){
    if (pasajerosCount >= capacidadMax) {
      alert('Capacidad completa: elimina a un pasajero para agregar uno nuevo.');
      return;
    }
    renderPasajeroForm(pasajerosCount);
  });

  // copiar tutor como pasajero 1
  const copyBtn = document.getElementById('btn-copy-tutor');
  const tutorData = {
    nombre: `{{ cliente.nombre|escapejs }}`,
    apellido: `{{ cliente.apellido|escapejs }}`,
    dni: `{{ cliente.dni|default:''|escapejs }}`,
    fecha_nacimiento: `{{ cliente.fecha_nacimiento|default:'' }}`
  };
  let tutorAdded = false;

  function isTutorData(data) {
    return (data.nombre || '').trim().toLowerCase() === tutorData.nombre.trim().toLowerCase()
        && (data.apellido || '').trim().toLowerCase() === tutorData.apellido.trim().toLowerCase()
        && (data.dni || '').trim() === tutorData.dni.trim();
  }

  copyBtn.addEventListener('click', function(){
    if (tutorAdded) {
      alert('El tutor solo puede agregarse una vez como pasajero.');
      return;
    }
    if (pasajerosCount >= capacidadMax) {
      alert('Capacidad completa: ya usaste todos los lugares de este camarote.');
      return;
    }
    renderPasajeroForm(pasajerosCount, tutorData);
    tutorAdded = true;
    copyBtn.setAttribute('disabled', 'disabled');
  });

  // inicio: si en sesión ya hay pasajeros pre-guardados, los renderizamos
  (function initFromSession(){
    const existing = JSON.parse(document.getElementById("pasajeros-data").textContent);

    if(Array.isArray(existing) && existing.length){
      existing.forEach((p, idx) => {
        renderPasajeroForm(idx, p);
        if (isTutorData(p)) {
          tutorAdded = true;
          copyBtn.setAttribute('disabled', 'disabled');
        }
      });
    } else {
      // por defecto, agregamos 1 form para facilitar
      renderPasajeroForm(0);
    }
  })();

  // actualizar carrito cuando el usuario escribe
  pasajerosArea.addEventListener('input', updateCarritoList);
</script>
{% endblock %}
