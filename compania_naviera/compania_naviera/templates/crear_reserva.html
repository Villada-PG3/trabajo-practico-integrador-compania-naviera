{% extends "base.html" %}
{% block content %}
<div class="flex items-center justify-center min-h-[80vh] px-4 py-12">
  <div class="card-surface backdrop-blur-xl rounded-3xl shadow-neon p-8 w-full max-w-2xl space-y-6">
    <div class="text-center space-y-2">
      <span class="inline-flex h-12 w-12 items-center justify-center rounded-full bg-primary text-white text-xl font-bold shadow-[0_12px_30px_rgba(5,24,36,0.15)]">
        <i class="fa-solid fa-clipboard-list"></i>
      </span>
      <h2 class="text-2xl font-bold">Crear reserva</h2>
      <p class="text-sm text-text/75">Completá los pasos para asignar pasajeros a tu próximo crucero.</p>
    </div>

    <form method="post" id="reservaForm" class="space-y-4">
      {% csrf_token %}

      <!-- Paso 0: Seleccionar cliente -->
      <div>
        <label class="block text-sm font-medium mb-1">Selecciona un cliente</label>
        <select name="cliente" id="cliente" class="form-control">
          <option value="">-- Selecciona un cliente --</option>
          {% for c in clientes %}
            <option value="{{ c.id }}">{{ c.nombre }} {{ c.apellido }}</option>
          {% endfor %}
        </select>
        <a href="{% url 'crear_cliente' %}" class="text-sm link-secondary inline-flex items-center gap-2">
          <i class="fa-solid fa-user-plus"></i> Crear nuevo cliente
        </a>
      </div>

      <!-- Paso 1: Seleccionar viaje -->
      <div>
        <label class="block text-sm font-medium mb-1">Selecciona un viaje</label>
        <select name="viaje_navio" id="viaje_navio" class="form-control">
          <option value="">-- Selecciona un viaje --</option>
          {% for v in viajes %}
            <option value="{{ v.id }}">
              {{ v.viaje.nombre }} — {{ v.navio.nombre }} ({{ v.viaje.fecha_de_salida }})
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Paso 2: Seleccionar tipo de camarote -->
      <div id="tipoDiv" style="display:none;">
        <label class="block text-sm font-medium mb-1">Selecciona tipo de camarote</label>
        <select name="tipo_camarote" id="tipo_camarote" class="form-control">
          <option value="">-- Selecciona tipo --</option>
        </select>
      </div>

      <!-- Paso 3: Seleccionar capacidad -->
      <div id="capacidadDiv" style="display:none;">
        <label class="block text-sm font-medium mb-1">Selecciona capacidad</label>
        <select name="capacidad" id="capacidad" class="form-control">
          <option value="">-- Selecciona capacidad --</option>
        </select>
      </div>

      <!-- Paso 4: Seleccionar camarote -->
      <div id="camaroteDiv" style="display:none;">
        <label class="block text-sm font-medium mb-1">Selecciona un camarote</label>
        <select name="camarote" id="camarote" class="form-control">
          <option value="">-- Selecciona un camarote --</option>
        </select>
      </div>

      <!-- Paso 5: Agregar pasajeros dinámicamente -->
      <div id="pasajerosDiv" style="display:none;">
        <label class="block text-sm font-medium mb-1">Agregar pasajeros</label>
        <div id="pasajerosContainer" class="space-y-2 mt-2"></div>
        <button type="button" id="agregarPasajeroBtn" class="btn-secondary inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium">
          <i class="fa-solid fa-user-plus"></i> Agregar pasajero
        </button>
      </div>

      <!-- Botón final -->
      <button type="submit" id="submitBtn"
              class="w-full btn-primary font-semibold py-3 rounded-xl shadow-lg transition mt-4 hidden">
        Confirmar Reserva
      </button>
    </form>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const viajeSelect = document.getElementById('viaje_navio');
  const tipoSelect = document.getElementById('tipo_camarote');
  const capacidadSelect = document.getElementById('capacidad');
  const camaroteSelect = document.getElementById('camarote');
  const tipoDiv = document.getElementById('tipoDiv');
  const capacidadDiv = document.getElementById('capacidadDiv');
  const camaroteDiv = document.getElementById('camaroteDiv');
  const pasajerosDiv = document.getElementById('pasajerosDiv');
  const pasajerosContainer = document.getElementById("pasajerosContainer");
  const agregarPasajeroBtn = document.getElementById("agregarPasajeroBtn");
  const submitBtn = document.getElementById('submitBtn');

  let capacidadMax = 0;
  let contadorPasajeros = 0;
  const applyFieldStyles = (element) => {
    element.classList.add(
      'w-full','rounded-lg','border','border-secondary/25','bg-bg/40','px-4','py-3','text-text',
      'placeholder-text/50','focus:outline-none','focus:ring-2','focus:ring-primary/60'
    );
  };

  document.querySelectorAll('.form-control').forEach(applyFieldStyles);

  // Función para crear inputs de pasajero
  function agregarPasajero(){
    if(contadorPasajeros >= capacidadMax){
      alert("Ya alcanzaste la capacidad máxima del camarote");
      return;
    }
    const div = document.createElement("div");
    div.classList.add("p-4", "rounded-xl", "border", "border-secondary/25", "bg-bg/35", "space-y-2");
    div.innerHTML = `
      <h4 class="font-semibold text-text">Pasajero ${contadorPasajeros + 1}</h4>
      <input type="text" name="pasajero_nombre_${contadorPasajeros}" placeholder="Nombre" class="pasajero-input" autocomplete="off">
      <input type="text" name="pasajero_apellido_${contadorPasajeros}" placeholder="Apellido" class="pasajero-input" autocomplete="off">
      <input type="text" name="pasajero_dni_${contadorPasajeros}" placeholder="DNI" class="pasajero-input" autocomplete="off">
      <input type="date" name="pasajero_fecha_nacimiento_${contadorPasajeros}" class="pasajero-input">
    `;
    pasajerosContainer.appendChild(div);
    div.querySelectorAll('.pasajero-input').forEach(applyFieldStyles);
    contadorPasajeros++;
  }

  agregarPasajeroBtn.addEventListener("click", agregarPasajero);

  // Eventos para cargar tipos, capacidades y camarotes (igual que antes)
  viajeSelect.addEventListener('change', async () => {
    const viajeId = viajeSelect.value;
    if (!viajeId) {
      tipoDiv.style.display = "none";
      capacidadDiv.style.display = "none";
      camaroteDiv.style.display = "none";
      pasajerosDiv.style.display = "none";
      submitBtn.classList.add("hidden");
      capacidadMax = 0;
      contadorPasajeros = 0;
      pasajerosContainer.innerHTML = "";
      return;
    }
    const res = await fetch(`/ajax/tipos-camarote/?viaje_navio_id=${viajeId}`);
    const data = await res.json();
    tipoSelect.innerHTML = `<option value="">-- Selecciona tipo --</option>`;
    data.forEach(t => tipoSelect.innerHTML += `<option value="${t.id}">${t.nombre}</option>`);
    tipoDiv.style.display = "block";
    capacidadDiv.style.display = "none";
    camaroteDiv.style.display = "none";
    pasajerosDiv.style.display = "none";
    submitBtn.classList.add("hidden");
    capacidadMax = 0;
    contadorPasajeros = 0;
    pasajerosContainer.innerHTML = "";
  });

  tipoSelect.addEventListener('change', async () => {
    const viajeId = viajeSelect.value;
    const tipoId = tipoSelect.value;
    if (!tipoId) {
      capacidadDiv.style.display = "none";
      camaroteDiv.style.display = "none";
      pasajerosDiv.style.display = "none";
      submitBtn.classList.add("hidden");
      return;
    }
    const res = await fetch(`/ajax/capacidades/?viaje_navio_id=${viajeId}&tipo_id=${tipoId}`);
    const data = await res.json();
    capacidadSelect.innerHTML = `<option value="">-- Selecciona capacidad --</option>`;
    data.forEach(c => capacidadSelect.innerHTML += `<option value="${c.capacidad}">${c.capacidad}</option>`);
    capacidadDiv.style.display = "block";
    camaroteDiv.style.display = "none";
    pasajerosDiv.style.display = "none";
    submitBtn.classList.add("hidden");
    capacidadMax = 0;
    contadorPasajeros = 0;
    pasajerosContainer.innerHTML = "";
  });

  capacidadSelect.addEventListener('change', async () => {
    const viajeId = viajeSelect.value;
    const tipoId = tipoSelect.value;
    const capacidad = capacidadSelect.value;
    if (!capacidad) {
      camaroteDiv.style.display = "none";
      pasajerosDiv.style.display = "none";
      submitBtn.classList.add("hidden");
      return;
    }
    const res = await fetch(`/ajax/camarotes/?viaje_navio_id=${viajeId}&tipo_id=${tipoId}&capacidad=${capacidad}`);
    const data = await res.json();
    camaroteSelect.innerHTML = `<option value="">-- Selecciona un camarote --</option>`;
    data.forEach(c => camaroteSelect.innerHTML += `<option value="${c.id}">N° ${c.numero_de_camarote} (${c.capacidad} pers.) - ${c.tipo}</option>`);
    camaroteDiv.style.display = "block";
    pasajerosDiv.style.display = "none";
    submitBtn.classList.add("hidden");
    capacidadMax = 0;
    contadorPasajeros = 0;
    pasajerosContainer.innerHTML = "";
  });

  camaroteSelect.addEventListener('change', () => {
    const camaroteId = camaroteSelect.value;
    if(!camaroteId){
      pasajerosDiv.style.display = "none";
      submitBtn.classList.add("hidden");
      capacidadMax = 0;
      contadorPasajeros = 0;
      pasajerosContainer.innerHTML = "";
      return;
    }
    capacidadMax = parseInt(camaroteSelect.options[camaroteSelect.selectedIndex].text.match(/\((\d+) pers\.\)/)[1]);
    pasajerosDiv.style.display = "block";
    submitBtn.classList.remove("hidden");
    contadorPasajeros = 0;
    pasajerosContainer.innerHTML = "";
  });

});
</script>
{% endblock %}
