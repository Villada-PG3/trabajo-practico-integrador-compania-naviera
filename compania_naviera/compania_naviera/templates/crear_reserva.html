{% extends "base.html" %}
{% block content %}
<div class="flex items-center justify-center min-h-[80vh] px-4 py-12">
  <div class="card-surface rounded-3xl shadow-lg p-8 w-full max-w-2xl space-y-6">
    <div class="text-center space-y-2">
      <span class="inline-flex h-12 w-12 items-center justify-center rounded-full bg-primary text-white text-xl font-bold shadow-[0_12px_30px_rgba(148,163,235,0.25)]">
        <i class="fa-solid fa-clipboard-list"></i>
      </span>
      <h2 class="text-2xl font-bold">Crear reserva</h2>
      <p class="text-sm text-text/75">Completá los pasos para asignar pasajeros a tu próximo crucero.</p>
    </div>

    <form method="post" id="reservaForm" class="space-y-6">
      {% csrf_token %}

      <!-- Paso 1: Cliente y viaje -->
      <div class="step-card">
        <div class="step-header">
          <span class="step-number">1</span>
          <div>
            <h3 class="step-title">Elegí al titular de la reserva</h3>
            <p class="step-description">Podés seleccionar un cliente existente o crear uno nuevo antes de continuar.</p>
          </div>
        </div>
        <select name="cliente" id="cliente" class="form-control">
          <option value="">Seleccioná al tutor de la reserva</option>
          {% for c in clientes %}
            <option value="{{ c.id }}">{{ c.nombre }} {{ c.apellido }}</option>
          {% endfor %}
        </select>
        <div class="flex flex-wrap items-center gap-3 justify-between">
          <div class="text-sm text-text/70">
            <span class="font-medium">Viaje elegido:</span>
            {{ viaje_seleccionado.viaje.nombre }} — {{ viaje_seleccionado.navio.nombre }}
          </div>
          <a href="{% url 'crear_cliente' %}" class="text-sm link-secondary inline-flex items-center gap-2">
            <i class="fa-solid fa-user-plus"></i> Crear nuevo cliente
          </a>
        </div>
        <input type="hidden" name="viaje_navio" value="{{ viaje_seleccionado.id }}">
      </div>

      <!-- Paso 2: Tipo de camarote -->
      <div id="tipoDiv" class="step-card" style="display:none;">
        <div class="step-header">
          <span class="step-number">2</span>
          <div>
            <h3 class="step-title">Definí el tipo de camarote</h3>
            <p class="step-description">Elegí la categoría que mejor se adapte a la experiencia del pasajero.</p>
          </div>
        </div>
        <select name="tipo_camarote" id="tipo_camarote" class="form-control">
          <option value="">Seleccioná un tipo</option>
        </select>
      </div>

      <!-- Paso 3: Capacidad -->
      <div id="capacidadDiv" class="step-card" style="display:none;">
        <div class="step-header">
          <span class="step-number">3</span>
          <div>
            <h3 class="step-title">Indicá la capacidad necesaria</h3>
            <p class="step-description">La capacidad determina cuántos pasajeros pueden asignarse al camarote.</p>
          </div>
        </div>
        <select name="capacidad" id="capacidad" class="form-control">
          <option value="">Seleccioná una capacidad</option>
        </select>
      </div>

      <!-- Paso 4: Camarote -->
      <div id="camaroteDiv" class="step-card" style="display:none;">
        <div class="step-header">
          <span class="step-number">4</span>
          <div>
            <h3 class="step-title">Seleccioná el camarote disponible</h3>
            <p class="step-description">Mostramos sólo los camarotes que cumplen con el tipo y la capacidad elegidos.</p>
          </div>
        </div>
        <select name="camarote" id="camarote" class="form-control">
          <option value="">Seleccioná un camarote</option>
        </select>
      </div>

      <!-- Paso 5: Pasajeros -->
      <div id="pasajerosDiv" class="step-card" style="display:none;">
        <div class="step-header">
          <span class="step-number">5</span>
          <div>
            <h3 class="step-title">Cargá los datos de cada pasajero</h3>
            <p class="step-description">Agregá a los viajeros uno por uno hasta completar la capacidad del camarote.</p>
          </div>
        </div>
        <div id="pasajerosContainer" class="space-y-3"></div>
        <button type="button" id="agregarPasajeroBtn" class="btn-secondary inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium">
          <i class="fa-solid fa-user-plus"></i> Agregar pasajero
        </button>
        <p class="text-xs text-text/60">Podés editar los campos de cada pasajero o eliminarlos antes de confirmar.</p>
      </div>

      <!-- Botón final -->
      <div class="flex justify-end">
        <button type="submit" id="submitBtn" class="btn-primary font-semibold px-6 py-3 rounded-xl transition hidden">
          Confirmar reserva
        </button>
      </div>
    </form>
  </div>
</div>

<div id="capacityToast" class="capacity-toast" role="alert" aria-live="assertive">
  <div class="toast-card">
    <span class="toast-icon">
      <i class="fa-solid fa-circle-exclamation"></i>
    </span>
    <div class="toast-content">
      <p class="toast-title">Capacidad alcanzada</p>
      <p class="toast-message" data-toast-message>Ya alcanzaste la capacidad máxima del camarote.</p>
    </div>
    <button type="button" class="toast-close" data-toast-close aria-label="Cerrar alerta">
      <i class="fa-solid fa-xmark"></i>
    </button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const viajeId = "{{ viaje_seleccionado.id }}";
  const tipoSelect = document.getElementById('tipo_camarote');
  const capacidadSelect = document.getElementById('capacidad');
  const camaroteSelect = document.getElementById('camarote');
  const tipoDiv = document.getElementById('tipoDiv');
  const capacidadDiv = document.getElementById('capacidadDiv');
  const camaroteDiv = document.getElementById('camaroteDiv');
  const pasajerosDiv = document.getElementById('pasajerosDiv');
  const pasajerosContainer = document.getElementById("pasajerosContainer");
  const agregarPasajeroBtn = document.getElementById("agregarPasajeroBtn");
  const submitBtn = document.getElementById('submitBtn');
  const capacityToast = document.getElementById("capacityToast");
  const capacityToastMessage = capacityToast ? capacityToast.querySelector("[data-toast-message]") : null;
  const capacityToastClose = capacityToast ? capacityToast.querySelector("[data-toast-close]") : null;
  let capacityToastTimer;

  let capacidadMax = 0;
  let contadorPasajeros = 0;

  const hideCapacityToast = () => {
    if (!capacityToast) return;
    capacityToast.classList.remove("toast-show");
    capacityToast.classList.add("toast-hide");
    clearTimeout(capacityToastTimer);
    capacityToastTimer = setTimeout(() => {
      capacityToast.style.display = "none";
      capacityToast.classList.remove("toast-hide");
    }, 220);
  };

  const showCapacityToast = (message) => {
    if (!capacityToast || !capacityToastMessage) return;
    capacityToastMessage.textContent = message;
    clearTimeout(capacityToastTimer);
    capacityToast.style.display = "flex";
    capacityToast.classList.remove("toast-show", "toast-hide");
    void capacityToast.offsetWidth;
    capacityToast.classList.add("toast-show");
    capacityToastTimer = setTimeout(hideCapacityToast, 3800);
  };

  if (capacityToastClose) {
    capacityToastClose.addEventListener("click", hideCapacityToast);
  }

  const applyFieldStyles = (element) => {
  element.classList.add(
    'w-full','rounded-lg','border','border-primary/40','step-input','px-4','py-3','text-text',
    'placeholder-gray-500','focus:outline-none','focus:ring-2','focus:ring-primary/60'
  );
};

  document.querySelectorAll('.form-control').forEach(applyFieldStyles);

  // Función para agregar pasajero
  function agregarPasajero(){
    if(contadorPasajeros >= capacidadMax){
      showCapacityToast("Ya alcanzaste la capacidad máxima del camarote");
      return;
    }
    const div = document.createElement("div");
    div.classList.add("p-4", "rounded-xl", "border", "border-primary/40", "pasajero-card", "space-y-2");
    div.innerHTML = `
      <h4 class="font-semibold text-text">Pasajero ${contadorPasajeros + 1}</h4>
      <input type="text" name="pasajero_nombre_${contadorPasajeros}" placeholder="Nombre" class="pasajero-input" autocomplete="off">
      <input type="text" name="pasajero_apellido_${contadorPasajeros}" placeholder="Apellido" class="pasajero-input" autocomplete="off">
      <input type="text" name="pasajero_dni_${contadorPasajeros}" placeholder="DNI" class="pasajero-input" autocomplete="off">
      <input type="date" name="pasajero_fecha_nacimiento_${contadorPasajeros}" class="pasajero-input">
    `;
    pasajerosContainer.appendChild(div);
    div.querySelectorAll('.pasajero-input').forEach(applyFieldStyles);
    contadorPasajeros++;
  }
  agregarPasajeroBtn.addEventListener("click", agregarPasajero);

  // Cargar tipos de camarote al cargar la página
  async function cargarTipos() {
    const res = await fetch(`/reservas/opciones/tipos-camarote/?viaje_navio_id=${viajeId}`);
    const data = await res.json();
    tipoSelect.innerHTML = `<option value="">-- Selecciona tipo --</option>`;
    data.forEach(t => tipoSelect.innerHTML += `<option value="${t.id}">${t.nombre}</option>`);
    tipoDiv.style.display = "block";
  }
  cargarTipos();

  tipoSelect.addEventListener('change', async () => {
    const tipoId = tipoSelect.value;
    if (!tipoId) {
      capacidadDiv.style.display = "none";
      camaroteDiv.style.display = "none";
      pasajerosDiv.style.display = "none";
      submitBtn.classList.add("hidden");
      return;
    }
    const res = await fetch(`/reservas/opciones/capacidades/?viaje_navio_id=${viajeId}&tipo_id=${tipoId}`);
    const data = await res.json();
    capacidadSelect.innerHTML = `<option value="">-- Selecciona capacidad --</option>`;
    data.forEach(c => capacidadSelect.innerHTML += `<option value="${c.capacidad}">${c.capacidad}</option>`);
    capacidadDiv.style.display = "block";
    camaroteDiv.style.display = "none";
    pasajerosDiv.style.display = "none";
    submitBtn.classList.add("hidden");
    capacidadMax = 0;
    contadorPasajeros = 0;
    pasajerosContainer.innerHTML = "";
  });

  capacidadSelect.addEventListener('change', async () => {
    const tipoId = tipoSelect.value;
    const capacidad = capacidadSelect.value;
    if (!capacidad) {
      camaroteDiv.style.display = "none";
      pasajerosDiv.style.display = "none";
      submitBtn.classList.add("hidden");
      return;
    }
    const res = await fetch(`/reservas/opciones/camarotes-disponibles/?viaje_navio_id=${viajeId}&tipo_id=${tipoId}&capacidad=${capacidad}`);
    const data = await res.json();
    camaroteSelect.innerHTML = `<option value="">-- Selecciona un camarote --</option>`;
    data.forEach(c => camaroteSelect.innerHTML += `<option value="${c.id}">N° ${c.numero_de_camarote} (${c.capacidad} pers.) - ${c.tipo}</option>`);
    camaroteDiv.style.display = "block";
    pasajerosDiv.style.display = "none";
    submitBtn.classList.add("hidden");
    capacidadMax = 0;
    contadorPasajeros = 0;
    pasajerosContainer.innerHTML = "";
  });

  camaroteSelect.addEventListener('change', () => {
    const camaroteId = camaroteSelect.value;
    if(!camaroteId){
      pasajerosDiv.style.display = "none";
      submitBtn.classList.add("hidden");
      capacidadMax = 0;
      contadorPasajeros = 0;
      pasajerosContainer.innerHTML = "";
      return;
    }
    capacidadMax = parseInt(camaroteSelect.options[camaroteSelect.selectedIndex].text.match(/\((\d+) pers\.\)/)[1]);
    pasajerosDiv.style.display = "block";
    submitBtn.classList.remove("hidden");
    contadorPasajeros = 0;
    pasajerosContainer.innerHTML = "";
  });

});
</script>
<style>
  .step-card {
    background: rgba(255, 255, 255, 0.97);
    border: 2px solid rgba(31, 58, 147, 0.28);
    border-radius: 1rem;
    padding: 1.25rem;
    box-shadow: 0 6px 16px rgba(15, 30, 99, 0.1);
    display: grid;
    gap: 1rem;
  }

  .step-input {
    background: linear-gradient(180deg, rgba(122, 62, 242, 0.14), rgba(255, 255, 255, 0.98));
  }

  .step-input:focus {
    background: rgba(255, 255, 255, 1);
  }

  .pasajero-card {
    background: linear-gradient(180deg, rgba(122, 62, 242, 0.16), rgba(255, 255, 255, 0.96));
    box-shadow: 0 6px 18px rgba(15, 30, 99, 0.12);
  }

  .step-header {
    display: flex;
    align-items: center;
    gap: 0.85rem;
  }

  .step-number {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 2.4rem;
    height: 2.4rem;
    border-radius: 9999px;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: #FFFFFF;
    font-weight: 700;
    font-size: 1rem;
    box-shadow: 0 4px 12px rgba(31, 58, 147, 0.25);
  }

  .step-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text);
  }

  .step-description {
    margin: 0;
    color: rgba(11, 19, 48, 0.65);
    font-size: 0.85rem;
  }

  .capacity-toast {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    z-index: 60;
    display: none;
    align-items: flex-end;
    justify-content: flex-end;
  }

  .capacity-toast.toast-show {
    animation: toast-in 0.25s ease forwards;
  }

  .capacity-toast.toast-hide {
    animation: toast-out 0.2s ease forwards;
  }

  .capacity-toast .toast-card {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 1rem 1.25rem;
    border-radius: 1.25rem;
    background: rgba(255, 255, 255, 0.97);
    border: 1px solid rgba(31, 58, 147, 0.42);
    box-shadow: 0 24px 48px rgba(15, 30, 99, 0.18);
    color: var(--text);
    backdrop-filter: blur(12px);
  }

  .capacity-toast .toast-icon {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 9999px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: rgba(122, 62, 242, 0.22);
    color: var(--secondary-dark);
    font-size: 1.05rem;
    flex-shrink: 0;
  }

  .capacity-toast .toast-title {
    margin: 0;
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--primary);
  }

  .capacity-toast .toast-message {
    margin: 0.15rem 0 0;
    font-size: 0.85rem;
    color: rgba(11, 19, 48, 0.7);
  }

  .capacity-toast .toast-close {
    margin-left: 0.75rem;
    border: none;
    background: transparent;
    color: rgba(11, 19, 48, 0.55);
    cursor: pointer;
    padding: 0.35rem;
    border-radius: 9999px;
    transition: background 0.2s ease, color 0.2s ease;
  }

  .capacity-toast .toast-close:hover {
    background: rgba(122, 62, 242, 0.18);
    color: var(--primary-dark);
  }

  @keyframes toast-in {
    from {
      opacity: 0;
      transform: translateY(12px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes toast-out {
    from {
      opacity: 1;
      transform: translateY(0);
    }
    to {
      opacity: 0;
      transform: translateY(12px);
    }
  }

  @media (max-width: 640px) {
    .capacity-toast {
      left: 1.5rem;
      right: 1.5rem;
      bottom: 1.5rem;
    }

    .capacity-toast .toast-card {
      width: 100%;
    }
  }

  .pasajero-input {
    background-color: rgba(229, 233, 255, 0.9) !important;
    color: var(--text) !important;
  }

  .pasajero-input::placeholder {
    color: rgba(11, 19, 48, 0.5) !important;
    opacity: 1;
  }
</style>
{% endblock %}
