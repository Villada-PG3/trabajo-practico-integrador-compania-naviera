{% extends "base.html" %}
{% block content %}
<div class="flex items-center justify-center min-h-[80vh]">
  <div class="bg-white/10 backdrop-blur-md rounded-2xl shadow-xl p-8 w-full max-w-xl">
    <h2 class="text-2xl font-bold text-center mb-6">Crear Reserva</h2>

    <form method="post" id="reservaForm" class="space-y-4">
      {% csrf_token %}

      <!-- Paso 1: Seleccionar viaje -->
      <div>
        <label class="block text-sm font-medium mb-1">Selecciona un viaje</label>
        <select name="viaje_navio" id="viaje_navio" class="form-control w-full p-2 rounded-lg bg-white text-black border border-gray-300">
          <option value="">-- Selecciona un viaje --</option>
          {% for v in viajes %}
            <option value="{{ v.id }}">
              {{ v.viaje.nombre }} — {{ v.navio.nombre }} ({{ v.viaje.fecha_de_salida }})
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Paso 2: Seleccionar camarote (rellenado por AJAX) -->
      <div id="camaroteDiv" style="display:none;">
        <label class="block text-sm font-medium mb-1">Selecciona un camarote</label>
        <select name="camarote" id="camarote" class="form-control w-full p-2 rounded-lg bg-white text-black border border-gray-300">
          <option value="">-- Selecciona un camarote --</option>
        </select>
      </div>

      <!-- Paso 3: Seleccionar pasajeros -->
      <div id="pasajerosDiv" style="display:none;">
        <label class="block text-sm font-medium mb-1">Selecciona los pasajeros</label>
        <small class="text-gray-400" id="capacidadText"></small>
        <div class="space-y-2 mt-2">
          {% for c in clientes %}
            <label class="flex items-center space-x-2">
              <input type="checkbox" name="pasajeros" value="{{ c.id }}" class="form-checkbox pasajeroCheckbox">
              <span>{{ c.nombre }} {{ c.apellido }}</span>
            </label>
          {% endfor %}
        </div>
        <small class="text-red-500 mt-1" id="excesoText" style="display:none;">Excediste la capacidad del camarote</small>
      </div>

      <!-- Botón final -->
      <button type="submit" id="submitBtn"
              class="w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 rounded-lg shadow-lg transition mt-4 hidden">
        Confirmar Reserva
      </button>
    </form>
  </div>
</div>

<script>
const viajeSelect = document.getElementById('viaje_navio');
const camaroteSelect = document.getElementById('camarote');
const camaroteDiv = document.getElementById('camaroteDiv');
const pasajerosDiv = document.getElementById('pasajerosDiv');
const submitBtn = document.getElementById('submitBtn');
const capacidadText = document.getElementById('capacidadText');
const excesoText = document.getElementById('excesoText');
let capacidadMax = 0;

// 1️⃣ Cuando seleccionás viaje → carga camarotes
viajeSelect.addEventListener('change', async () => {
  const viajeId = viajeSelect.value;
  if (!viajeId) return;

  const res = await fetch(`?viaje_navio_id=${viajeId}`);
  const data = await res.json();

  camaroteSelect.innerHTML = `<option value="">-- Selecciona un camarote --</option>`;
  data.forEach(c => {
    camaroteSelect.innerHTML += `<option value="${c.id}">
      Camarote ${c.numero_de_camarote} (${c.tipo_camarote__nombre}) — Capacidad ${c.capacidad}
    </option>`;
  });

  camaroteDiv.style.display = "block";
  pasajerosDiv.style.display = "none";
  submitBtn.classList.add("hidden");
  capacidadMax = 0;
  excesoText.style.display = "none";
  document.querySelectorAll('.pasajeroCheckbox').forEach(cb => cb.checked = false);
});

// 2️⃣ Cuando seleccionás camarote → mostrar pasajeros y capacidad
camaroteSelect.addEventListener('change', async () => {
  const camaroteId = camaroteSelect.value;
  if (!camaroteId) return;

  const res = await fetch(`?camarote_id=${camaroteId}`);
  const data = await res.json();
  capacidadMax = data.capacidad;
  capacidadText.innerText = `Capacidad máxima: ${capacidadMax} personas`;

  pasajerosDiv.style.display = "block";
  submitBtn.classList.remove("hidden");
  excesoText.style.display = "none";

  // Desmarcar todos los checkboxes al cambiar camarote
  document.querySelectorAll('.pasajeroCheckbox').forEach(cb => cb.checked = false);
});

// 3️⃣ Validar capacidad al seleccionar pasajeros
document.querySelectorAll('.pasajeroCheckbox').forEach(cb => {
  cb.addEventListener('change', () => {
    const seleccionados = document.querySelectorAll('.pasajeroCheckbox:checked').length;
    if (seleccionados > capacidadMax) {
      excesoText.style.display = "block";
      submitBtn.disabled = true;
    } else {
      excesoText.style.display = "none";
      submitBtn.disabled = false;
    }
  });
});
</script>
{% endblock %}
