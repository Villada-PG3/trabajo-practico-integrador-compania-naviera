{% extends "base.html" %}
{% block content %}
<div class="max-w-4xl mx-auto p-6">
  <h1 class="text-2xl font-bold">Tutor y pasajeros</h1>
  <p class="text-sm text-muted">Primero elegí quién será el tutor (responsable de la reserva). Luego completá los pasajeros.</p>

  <form method="post">
    {% csrf_token %}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <label class="block text-sm font-medium">Tutor de la reserva</label>
        <select name="tutor_id" required class="mt-2 w-full border rounded p-2">
          <option value="">-- Seleccioná un cliente --</option>
          {% for c in clientes %}
            <option value="{{ c.id }}">{{ c.nombre }} {{ c.apellido }} - DNI: {{ c.dni }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium">Capacidad seleccionada</label>
        <div class="mt-2 text-lg font-semibold">{{ capacidad }}</div>
      </div>
    </div>

    <hr class="my-6">

    <div>
      <h2 class="text-lg font-semibold">Pasajeros</h2>
      <p class="text-sm text-muted">Completá los datos de cada pasajero. Al menos uno es obligatorio.</p>

      <div class="space-y-4 mt-4">
        {% for i in range|make_list:capacidad %}
          <!-- usamos indices 0..capacidad-1 -->
        {% endfor %}
      </div>

      <!-- GENERAMOS campos con JS para no repetir en el template -->
      <div id="pasajeros-container"></div>

      <div class="mt-6 flex items-center gap-3">
        <a href="{% url 'reserva_step2' %}" class="px-4 py-2 rounded bg-gray-100">Volver</a>
        <button type="submit" class="px-4 py-2 rounded bg-primary text-white">Siguiente (Confirmar)</button>
      </div>
    </div>
  </form>
</div>
<script>
  // Cambiamos el nombre a una variable única
    const capacidadCamarote = parseInt("{{ capacidad|default:1 }}") || 1;

  const cont = document.getElementById('pasajeros-container');

  function createPasajeroForm(index) {
    const wrapper = document.createElement('div');
    wrapper.className = 'p-4 border rounded space-y-2';

    wrapper.innerHTML = `
      <div class="flex items-center justify-between">
        <h3 class="font-semibold">Pasajero ${index+1}</h3>
        <label class="inline-flex items-center text-sm">
          <input type="checkbox" class="mr-2 tutor-as-p1" data-index="${index}">
          El tutor es este pasajero
        </label>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-sm">Nombre</label>
          <input name="pasajero_${index}_nombre" class="w-full border rounded p-2" />
        </div>
        <div>
          <label class="text-sm">Apellido</label>
          <input name="pasajero_${index}_apellido" class="w-full border rounded p-2" />
        </div>
        <div>
          <label class="text-sm">DNI</label>
          <input name="pasajero_${index}_dni" class="w-full border rounded p-2" />
        </div>
        <div>
          <label class="text-sm">Fecha de nacimiento</label>
          <input type="date" name="pasajero_${index}_fecha_nac" class="w-full border rounded p-2" />
        </div>
      </div>
    `;
    cont.appendChild(wrapper);
  }

  // Creamos la cantidad correcta de formularios
  for (let i = 0; i < capacidadCamarote; i++) {
    createPasajeroForm(i);
  }

  // Cuando marcan "El tutor es este pasajero"
  document.addEventListener('change', function(e) {
    if (!e.target.classList.contains('tutor-as-p1')) return;

    const index = e.target.dataset.index;

    if (e.target.checked) {
      const dni = document.querySelector(`input[name="pasajero_${index}_dni"]`).value;
      alert('Si el tutor ya está registrado como cliente, seleccionarlo en el menú. Podemos automatizar por DNI si querés.');
    }
  });
</script>
